---
config:
  layout: elk
  theme: 'base'
  themeVariables:
    darkMode: true
    background: '#000000ff'
    
    # MAIN NODES (Classes)
    primaryColor: '#1f1f1f'       # Dark Grey
    primaryTextColor: '#e0e0e0'   # White Text
    primaryBorderColor: '#00bfff' # Cyan Border
    
    # LINES
    lineColor: '#00bfff'          # Cyan Connecting Lines
    
    # NAMESPACES / CLUSTERS
    # These control the "box" around your packages
    tertiaryColor: '#252525'      # Slightly lighter grey than background
    tertiaryBorderColor: '#00bfff' # Cyan border to make the box visible
    clusterBkg: '#252525'         # (Redundant backup for some renderers)
    clusterBorder: '#00bfff'      # (Redundant backup for some renderers)
---
classDiagram
    direction RL

    %% ==========================================
    %% EXTERNAL LIBRARY: Terminal.Gui
    %% ==========================================
    namespace Terminal_Gui {
        class Application {
            <<External>>
            +static Toplevel Top
            +static Init()
            +static Run()
            +static RequestStop()
            +static Shutdown()
        }

        class Toplevel {
            <<External>>
            +Add(View view)
        }

        class Window {
            <<External>>
            +Title
            +ColorScheme
            +Add(View view)
            +Remove(View view)
        }

        class View {
            <<External>>
            +X
            +Y
            +Width
            +Height
        }

        class MenuBar {
            <<External>>
            +MenuBar(MenuBarItem[] items)
        }

        class MenuBarItem {
            <<External>>
            +MenuBarItem(string title, MenuItem[] children)
        }

        class MenuItem {
            <<External>>
            +MenuItem(string title, string help, Action action)
        }

        class MessageBox {
            <<External>>
            +static Query(string title, string message, string[] buttons) int
            +static ErrorQuery(string title, string message, string[] buttons) int
        }
        
        class Button { <<External>> }
        class TextField { <<External>> }
        class Label { <<External>> }
        class ListView { <<External>> }
    }

    %% Inheritance from External Library
    Window --|> View
    Button --|> View
    TextField --|> View
    Label --|> View
    ListView --|> View
    Toplevel --|> View

    %% ==========================================
    %% INTERNAL DOMAIN: CpE261FinalProject
    %% ==========================================

    namespace Banter_Models{
        class User {
            +ObjectId? id
            +String Email
            +String Name
            +String Password
            +String Username
            +List~string~ Chatrooms
        }

        class Chatroom {
            +ObjectId? id
            +String? ChatroomName
            +String? LastChat
            +List~string~ Participants
            +String Type
            +List~Message~ Messages
            +List~string~ Admins
        }

        class Message {
            +ObjectId? id
            +String SenderId
            +String Text
            +DateTime Timestamp
        }
    }

    Chatroom *-- Message : Contains

    namespace Banter_Handlers{
        class SessionHandler {
            <<Static>>
            -static FirestoreChangeListener? chatroomsListener
            -static string? _username
            -static string? _name
            -static string? _user_id
            -static string? _current_chatroom_id
            -static bool _isLoggedIn
            -static List~tuple~ _userChatrooms
            +static event Action~string?~ UsernameChanged
            +static event Action~string?~ NameChanged
            +static event Action~string?~ UserIdChanged
            +static event Action~string?~ CurrentChatroomChanged
            +static event Action~bool~ IsLoggedInChanged
            +static event Action~List~tuple~~ UserChatroomsChanged
            +static string? Username
            +static string? Name
            +static string? UserId
            +static string? CurrentChatroomId
            +static bool IsLoggedIn
            +static List~tuple~ Chatrooms
            +static ClearSession()
            +static StartChatroomsListener()
        }

        class LocalCacheHandler {
            <<Static>>
            -static LiteDatabase db
            -static ILiteCollection~User~ users
            +static event Action~List~User~~ UsersCacheUpdated
            +static CacheUser(user)
        }
    }

    namespace Banter_Utilities{
        class Validator {
            <<Static>>
            -const string EmailRegexPattern
            +static IsValidEmail(email) bool
        }

        class ProfanityChecker {
            <<Static>>
            -static string[] ProfaneWordsArray
            -static Regex SimpleProfanityRegex
            -static Dictionary~char,char~ LeetMap
            +static CensorTextSimple(text) string
            +static CensorTextRobust(text) string
        }

        class CustomColorScheme {
            <<Static>>
            +static ColorScheme Window
            +static ColorScheme Button
            +static ColorScheme LabelEmpty
        }

        class WindowHelper {
            <<Static>>
            +static FocusWindow(window)
            +static OpenWindow(window)
            +static CloseWindow(window)
            +static CloseAllWindows()
            +static GetDistanceX(left, right) int
        }
    }

    namespace Banter_Utilities_Firebase{
        class FirestoreManager {
            <<Singleton>>
            -static Lazy~FirestoreManager~ lazyInstance
            +static FirestoreManager Instance
            +FirestoreDb Database
            -FirestoreManager()
        }

        class FirebaseHelper {
            <<Static>>
            +static FirestoreDb db
            +static ChangeChatroomName(id, new_name)
            +static RemoveChatroomParticipant(p_id, c_id)
            +static ValidateChatroomAdmin(user_id) bool
            +static GetChatroomAdmins(id) List~string~
            +static CreateChatroom(participant_ids)
            +static DeleteChatroomById(id)
            +static GetChatroomTypeById(id) string
            +static ClearChatroomMessagesById(id)
            +static GetChatroomNameById(id) string
            +static GetChatroomParticipants(id) Dictionary~string,string~
            +static GetUserName(user_id) string
            +static GetUserInfoById(user_id) Dictionary
            +static GetUserIdFromUsername(username) string?
            +static ValidateUsername(username) bool
            +static IsUsernameTaken(username) bool
            +static AddAccount(user) bool
        }
    }

    FirebaseHelper ..> FirestoreManager : Uses Instance
    FirebaseHelper ..> User : Creates/Reads
    FirebaseHelper ..> Chatroom : Creates/Reads/Updates
    SessionHandler ..> FirebaseHelper : Calls methods
    SessionHandler ..> FirestoreManager : Uses Listener
    
    namespace Banter_Utilities{
        class IViewable {
            <<Interface>>
            +Show()
            +Hide()
        }

        class AbstractWindow {
            <<Abstract>>
        }

        class FixedWindow {
            +FixedWindow()
            +MouseEvent(me) bool
        }
    }

    AbstractWindow ..|> IViewable : Implements
    FixedWindow --|> Window : Inherits Terminal.Gui.Window
    
    namespace Banter_Windows{
        class LogInWindow {
            <<Singleton>>
            -static Lazy~LogInWindow~ lazyInstance
            +static LogInWindow Instance
            -Window window
            -TextField usernameTextField
            -TextField passwordTextField
            -Button logInButton
            -Button createAccountButton
            -OnLogInButtonClicked()
            -OnCreateAccountButtonClicked()
            +Show()
            +Hide()
        }

        class CreateAccountWindow {
            <<Singleton>>
            -static Lazy~CreateAccountWindow~ lazyInstance
            +static CreateAccountWindow Instance
            -Window window
            -TextField usernameTextField
            -TextField passwordTextField
            -TextField emailTextField
            -Button createAccountButton
            -OnCreateAccountButtonClicked()
            +Show()
            +Hide()
        }

        class Window1 {
            <<Singleton>>
            -static Lazy~Window1~ lazyInstance
            +static Window1 Instance
            -Window window
            -ListView chatroomsListView
            -Button createChatroomButton
            -OnCreateChatroomButtonClicked()
            -OnUserChatroomsChanged()
            -Toggle(isLoggedIn)
            +Show()
            +Hide()
        }

        class Window2 {
            <<Singleton>>
            -static Lazy~Window2~ lazyInstance
            +static Window2 Instance
            -Window window
            -ListView chatHistory
            -TextField chatBox
            -Button buttonSend
            -Dictionary~string,string~ currentChatroomParticipants
            -FirestoreChangeListener? _listener
            -OnButtonSendClicked()
            -OnChatroomChanged(id)
            -OnSnapshotReceived(snapshot)
            -StartListener(id)
            +Show()
            +Hide()
        }

        class Window3 {
            <<Singleton>>
            -static Lazy~Window3~ lazyInstance
            +static Window3 Instance
            -Window window
            -Button clearMessagesButton
            -Button changeChatroomNameButton
            -OnCurrentChatroomChanged()
            -OnClearMessagesButtonClicked()
            +Show()
            +Hide()
        }

        class CreateChatroomWindow {
            <<Singleton>>
            -static Lazy~CreateChatroomWindow~ lazyInstance
            +static CreateChatroomWindow Instance
            -Window window
            -List~string~ participants
            -List~string~ participants_ids
            -OnAddButtonClicked()
            -OnCreateButtonClicked()
            +Show()
            +Hide()
        }

        class ChangeChatroomNameWindow {
            <<Singleton>>
            -static Lazy~ChangeChatroomNameWindow~ lazyInstance
            +static ChangeChatroomNameWindow Instance
            -Window window
            -TextField newNameTextField
            -OnSetButtonClicked()
            +Show()
            +Hide()
        }

        class Program {
            -static Main()
        }
    }

    %% Internal Window Relationships
    LogInWindow --|> AbstractWindow
    CreateAccountWindow --|> AbstractWindow
    Window1 --|> AbstractWindow
    Window2 --|> AbstractWindow
    Window3 --|> AbstractWindow
    CreateChatroomWindow --|> AbstractWindow
    ChangeChatroomNameWindow --|> AbstractWindow
    
    %% Dependencies
    LogInWindow ..> FirebaseHelper : Validates User
    LogInWindow ..> SessionHandler : Updates Session
    CreateAccountWindow ..> Validator : Validates Email
    CreateAccountWindow ..> FirebaseHelper : Adds Account
    Window1 ..> SessionHandler : Listens to UserChatrooms
    Window1 ..> CreateChatroomWindow : Opens
    Window2 ..> SessionHandler : Listens to CurrentChatroom
    Window2 ..> FirebaseHelper : Fetches Participants
    Window2 ..> ProfanityChecker : Censors Text
    Window2 ..> FirestoreManager : Listens to Messages
    Window3 ..> SessionHandler : Listens to CurrentChatroom
    Window3 ..> FirebaseHelper : Clears/Deletes/Leaves
    Window3 ..> ChangeChatroomNameWindow : Opens
    CreateChatroomWindow ..> FirebaseHelper : Creates Chatroom
    CreateChatroomWindow ..> SessionHandler : Reads Username
    ChangeChatroomNameWindow ..> FirebaseHelper : Updates Name
    ChangeChatroomNameWindow ..> SessionHandler : Reads ChatroomId
    LogInWindow ..> CustomColorScheme : Uses
    Window1 ..> CustomColorScheme : Uses
    Window2 ..> CustomColorScheme : Uses
    Window3 ..> CustomColorScheme : Uses
    AbstractWindow ..> WindowHelper : Uses

    %% Program Integration
    Program ..> Application : Calls Init/Run
    Program ..> MenuBar : Creates
    Program ..> MessageBox : Uses
    Program ..> LogInWindow : Shows Instance
    
    %% Dependencies to External Library
    LogInWindow ..> Window : Composes
    LogInWindow ..> Button : Composes
    LogInWindow ..> TextField : Composes
    Window1 ..> Window : Composes
    Window1 ..> ListView : Composes
    Window2 ..> Window : Composes
    Window2 ..> ListView : Composes
    Window3 ..> Window : Composes
    Window3 ..> Button : Composes
    
    %% Styling for External Nodes
    class Application{<<external>>}
    class Toplevel{<<external>>}
    class Window{<<external>>}
    class View{<<external>>}
    class MenuBar{<<external>>}
    class MenuBarItem{<<external>>}
    class MenuItem{<<external>>}
    class MessageBox{<<external>>}
    class Button{<<external>>}
    class TextField{<<external>>}
    class Label{<<external>>}
    class ListView{<<external>>}